language: 'rust'
type: 'application'
project:
  description: The ember-link server using the tokio runtime
  metadata:
    version: 0.1.0

dependsOn:
  - 'protocol'
  - 'server'

tasks:
  flamegraph:
    script: |
      CARGO_PROFILE_RELEASE_DEBUG=true PERF=/usr/lib/linux-tools/6.8.0-60-generic/perf cargo flamegraph
    local: true
  run:
    command: 'cargo run'
    local: true
  test:
    command: 'cargo test'
  test-cov:
    command: 'llvm-cov --html'
  build-release:
    command: 'cargo build --release'
  build-docker:
    command: 'docker build -f "apps/ember-link/Dockerfile" . -t emberlinkio/ember-link:latest'
    options:
      runFromWorkspaceRoot: true
  tag-docker:
    command: 'docker tag emberlinkio/ember-link:latest emberlinkio/ember-link:$META_VERSION'
    env:
      META_VERSION: '@meta(version)'
